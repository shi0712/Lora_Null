# è®­ç»ƒåé›¶ç©ºé—´éªŒè¯è¯´æ˜

## æ¦‚è¿°

`verify_trained_null_space.py` ç”¨äºéªŒè¯ LoRA-Null-v2 æ¨¡å‹**è®­ç»ƒå**çš„é›¶ç©ºé—´å±æ€§ï¼Œå¸®åŠ©ä½ ç†è§£ï¼š
1. è®­ç»ƒåé›¶ç©ºé—´å±æ€§æ˜¯å¦ä¿æŒ
2. é€‚é…å™¨æ˜¯å¦å­¦åˆ°äº†æœ‰æ•ˆçš„æ›´æ–°
3. é€‚é…å™¨å¯¹æ¨¡å‹è¾“å‡ºçš„å®é™…è´¡çŒ®

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# éªŒè¯è®­ç»ƒåçš„æ¨¡å‹
python verify_trained_null_space.py \
    --trained_model_path save_LoRA_Null_adapter_llama2_PT_128_math_Null_v2_trained/ft \
    --calib_loader_size 16

# ä½¿ç”¨æ›´å¤šæ ·æœ¬è¿›è¡ŒéªŒè¯
python verify_trained_null_space.py \
    --trained_model_path save_LoRA_Null_adapter_llama2_PT_128_math_Null_v2_trained/ft \
    --calib_loader_size 256 \
    --max_activation_samples 200

# ä¿å­˜ç»Ÿè®¡ç»“æœ
python verify_trained_null_space.py \
    --trained_model_path save_LoRA_Null_adapter_llama2_PT_128_math_Null_v2_trained/ft \
    --save_stats verification_results.json
```

### å‚æ•°è¯´æ˜

- `--trained_model_path`: **å¿…éœ€**ï¼Œè®­ç»ƒåæ¨¡å‹è·¯å¾„ï¼ˆé€šå¸¸æ˜¯ `output_dir/ft`ï¼‰
- `--calib_dataset`: æ ¡å‡†æ•°æ®é›†ï¼Œé»˜è®¤ `wikitext2`
- `--calib_loader_size`: æ ¡å‡†æ ·æœ¬æ•°é‡ï¼Œé»˜è®¤ 16
- `--max_activation_samples`: æ¯å±‚æ”¶é›†çš„æ¿€æ´»æ ·æœ¬æ•°ï¼Œé»˜è®¤ 100
- `--save_stats`: ä¿å­˜ç»Ÿè®¡ç»“æœçš„ JSON æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰

## éªŒè¯æŒ‡æ ‡è¯¦è§£

### 1. é›¶ç©ºé—´ä¿æŒæ€§ï¼š`||BX|| / ||X||`

**ç‰©ç†æ„ä¹‰**: è®­ç»ƒåï¼Œè¾“å…¥æŠ•å½±åˆ° B ç©ºé—´çš„å¹…åº¦

**é¢„æœŸå€¼**:
- âœ… **< 0.1**: é›¶ç©ºé—´å±æ€§ä¿æŒè‰¯å¥½
- âš ï¸ **0.1 - 0.5**: é›¶ç©ºé—´å±æ€§æœ‰æ‰€é€€åŒ–ï¼Œä½†ä»å¯æ¥å—
- âŒ **> 0.5**: é›¶ç©ºé—´å±æ€§ä¸¥é‡é€€åŒ–

**è§£é‡Š**:
- ç†è®ºä¸Šï¼Œå¦‚æœ BLinear æƒé‡å®Œå…¨å†»ç»“ï¼Œè¿™ä¸ªå€¼åº”è¯¥å’Œåˆå§‹åŒ–æ—¶ä¸€æ ·
- å¦‚æœè¿™ä¸ªå€¼æ˜¾è‘—å¢å¤§ï¼Œè¯´æ˜ï¼š
  - BLinear æƒé‡è¢«æ›´æ–°äº†ï¼ˆæ£€æŸ¥è®­ç»ƒä»£ç çš„å‚æ•°å†»ç»“ï¼‰
  - æˆ–è€…æ•°æ®åˆ†å¸ƒå‘ç”Ÿäº†å˜åŒ–

### 2. é€‚é…å™¨æœ‰æ•ˆæ€§ï¼š`||ABX|| / ||X||`

**ç‰©ç†æ„ä¹‰**: é€‚é…å™¨è¾“å‡ºç›¸å¯¹äºè¾“å…¥çš„å¹…åº¦

**é¢„æœŸå€¼**:
- âœ… **> 1e-4**: é€‚é…å™¨å­¦åˆ°äº†æœ‰æ•ˆçš„æ›´æ–°
- âš ï¸ **1e-6 ~ 1e-4**: é€‚é…å™¨æ›´æ–°è¾ƒå°ï¼Œå¯èƒ½æ¬ æ‹Ÿåˆ
- âŒ **< 1e-6**: é€‚é…å™¨å‡ ä¹æ²¡å˜åŒ–ï¼ˆå¯èƒ½ ALinear è¢«é”™è¯¯å†»ç»“ï¼‰

**è§£é‡Š**:
- åˆå§‹åŒ–æ—¶ A=0ï¼Œæ‰€ä»¥ ABX=0
- è®­ç»ƒå A åº”è¯¥æ›´æ–°ï¼Œæ‰€ä»¥ ABX â‰  0
- è¿™ä¸ªå€¼è¶Šå¤§ï¼Œè¯´æ˜é€‚é…å™¨çš„è´¡çŒ®è¶Šå¤§

### 3. é€‚é…å™¨è´¡çŒ®ï¼š`||ABX|| / ||å®Œæ•´è¾“å‡º||`

**ç‰©ç†æ„ä¹‰**: é€‚é…å™¨åœ¨æ€»è¾“å‡ºä¸­çš„ç›¸å¯¹è´¡çŒ®

**é¢„æœŸå€¼**:
- âœ… **> 1%**: é€‚é…å™¨å¯¹è¾“å‡ºæœ‰æ˜¾è‘—å½±å“
- âš ï¸ **0.1% ~ 1%**: é€‚é…å™¨å½±å“è¾ƒå°
- âŒ **< 0.1%**: é€‚é…å™¨å‡ ä¹æ²¡æœ‰å½±å“

**è§£é‡Š**:
- æ€»è¾“å‡º = ABX + W_residual @ X
- è¿™ä¸ªæ¯”å€¼è¡¡é‡äº†é€‚é…å™¨åœ¨æ€»è¾“å‡ºä¸­çš„é‡è¦æ€§
- å¦‚æœå¤ªå°ï¼Œè¯´æ˜è®­ç»ƒå¯èƒ½ä¸å¤Ÿå……åˆ†

### 4. æƒé‡èŒƒæ•°

è¾“å‡ºä¸‰ä¸ªæƒé‡çŸ©é˜µçš„ Frobenius èŒƒæ•°ï¼š
- `||B||_F`: BLinear æƒé‡çš„èŒƒæ•°ï¼ˆåº”è¯¥å’Œåˆå§‹åŒ–æ—¶æ¥è¿‘ï¼‰
- `||A||_F`: ALinear æƒé‡çš„èŒƒæ•°ï¼ˆè®­ç»ƒååº”è¯¥ > 0ï¼‰
- `||W_residual||_F`: æ®‹å·®æƒé‡çš„èŒƒæ•°ï¼ˆä¿æŒä¸å˜ï¼‰

## è¾“å‡ºç¤ºä¾‹

```
============================================================
Layer: model.layers.0.self_attn.q_proj
============================================================
è¾“å…¥æ ·æœ¬æ•°: 100
è¾“å…¥ç»´åº¦: 4096, ç§©: 128, è¾“å‡ºç»´åº¦: 4096
------------------------------------------------------------
æ¿€æ´»å€¼èŒƒæ•°:
  ||X|| (avg):           12.345678
  ||BX|| (avg):          0.123456
  ||ABX|| (avg):         0.234567
  ||W_residual @ X||:    11.987654
  ||å®Œæ•´è¾“å‡º||:           12.456789
------------------------------------------------------------
é›¶ç©ºé—´æŒ‡æ ‡:
  ||BX|| / ||X||:        1.000e-02 âœ“ ä»ç„¶å¾ˆå°
  ||ABX|| / ||X||:       1.900e-02 âœ“ é€‚é…å™¨æ›´æ–°æœ‰æ•ˆ
------------------------------------------------------------
é€‚é…å™¨è´¡çŒ®:
  ||ABX|| / ||è¾“å‡º||:    1.883e-02 (é€‚é…å™¨åœ¨æ€»è¾“å‡ºä¸­çš„ç›¸å¯¹è´¡çŒ®)
------------------------------------------------------------
æƒé‡èŒƒæ•°:
  ||B||_F:               123.456789
  ||A||_F:               45.678901
  ||W_residual||_F:      234.567890
============================================================

============================================================
æ±‡æ€»ç»Ÿè®¡ï¼ˆæ‰€æœ‰å±‚å¹³å‡ï¼‰
============================================================
å¹³å‡ ||BX|| / ||X||:        9.876e-03
å¹³å‡ ||ABX|| / ||X||:       2.134e-02
å¹³å‡é€‚é…å™¨è´¡çŒ®æ¯”:            1.856e-02
============================================================

ğŸ“Š ç»“æœè§£è¯»:
------------------------------------------------------------
âœ… ||BX|| / ||X|| < 0.1: é›¶ç©ºé—´å±æ€§ä¿æŒè‰¯å¥½
   è¾“å…¥æŠ•å½±åˆ° B ç©ºé—´åå¹…åº¦ä»ç„¶å¾ˆå°ï¼Œè¯´æ˜ B ä»åœ¨è¿‘ä¼¼é›¶ç©ºé—´ä¸­

âœ… ||ABX|| / ||X|| = 2.13e-02: é€‚é…å™¨å­¦åˆ°äº†æœ‰æ•ˆçš„æ›´æ–°
   ALinear æƒé‡å·²ç»ä»åˆå§‹çš„0æ›´æ–°åˆ°æœ‰æ„ä¹‰çš„å€¼

âœ… é€‚é…å™¨è´¡çŒ® 1.86%: å¯¹æ¨¡å‹è¾“å‡ºæœ‰æ˜æ˜¾å½±å“
------------------------------------------------------------
```

## ä¸åˆå§‹åŒ–æ—¶çš„å¯¹æ¯”

| æŒ‡æ ‡ | åˆå§‹åŒ–æ—¶ (build_adapter) | è®­ç»ƒå (verify_trained) |
|------|-------------------------|------------------------|
| `||BX|| / ||X||` | åº”è¯¥å¾ˆå° (1e-4 ~ 1e-2) | **åº”è¯¥ä¿æŒæ¥è¿‘** |
| `||ABX|| / ||X||` | â‰ˆ 0 (< 1e-6) | **åº”è¯¥æ˜¾è‘—å¢å¤§** (> 1e-4) |
| `||A||_F` | â‰ˆ 0 | **åº”è¯¥ > 0** |
| `||B||_F` | å›ºå®šå€¼ | **åº”è¯¥ä¿æŒä¸å˜** |

## å¸¸è§é—®é¢˜è¯Šæ–­

### é—®é¢˜1: `||BX|| / ||X||` æ˜¾è‘—å¢å¤§ï¼ˆ> 0.5ï¼‰

**å¯èƒ½åŸå› **:
- BLinear æƒé‡åœ¨è®­ç»ƒä¸­è¢«æ›´æ–°äº†

**æ£€æŸ¥æ–¹æ³•**:
```python
# æŸ¥çœ‹è®­ç»ƒè„šæœ¬ train_model_freeze_a.py:185-189
if "ALinear" not in n and "BLinear" not in n and p.requires_grad:
    p.requires_grad = False
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ BLinear åœ¨è®­ç»ƒæ—¶è¢«æ­£ç¡®å†»ç»“
- æ£€æŸ¥ç¬¬185è¡Œä»£ç é€»è¾‘ï¼ˆæ³¨æ„æœ‰ä¸ª bugï¼š`"ALinear" not in n and "ALinear" not in n"` åº”è¯¥æ˜¯ `"ALinear" not in n and "BLinear" not in n"`ï¼‰

### é—®é¢˜2: `||ABX|| / ||X||` å¾ˆå°ï¼ˆ< 1e-6ï¼‰

**å¯èƒ½åŸå› **:
- ALinear è¢«é”™è¯¯å†»ç»“äº†
- å­¦ä¹ ç‡è¿‡å°
- è®­ç»ƒæ­¥æ•°ä¸å¤Ÿ

**æ£€æŸ¥æ–¹æ³•**:
```bash
# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—ä¸­çš„å¯è®­ç»ƒå‚æ•°ç»Ÿè®¡
grep "trainable params" train.log
```

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿åªæœ‰ ALinear å’Œ BLinear å¯è®­ç»ƒ
- å¢å¤§å­¦ä¹ ç‡æˆ–è®­ç»ƒæ›´å¤šæ­¥æ•°

### é—®é¢˜3: é€‚é…å™¨è´¡çŒ®å¾ˆå°ï¼ˆ< 0.1%ï¼‰

**å¯èƒ½åŸå› **:
- é€‚é…å™¨ç§©å¤ªå°
- è®­ç»ƒä¸å……åˆ†
- å­¦ä¹ ç‡å¤ªå°

**è§£å†³æ–¹æ¡ˆ**:
- å¢å¤§ rank (ä¾‹å¦‚ä» 128 â†’ 256)
- å¢åŠ è®­ç»ƒ epochs
- è°ƒæ•´å­¦ä¹ ç‡

## å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

```bash
# Step 1: æ„å»ºåˆå§‹é€‚é…å™¨
python build_adapter.py \
    --model_id meta-llama/Llama-2-7b-hf \
    --singular_aware_2 \
    --r 128 \
    --save_model \
    --save_path save_LoRA_Null_adapter_llama2_PT_128

# Step 2: è®­ç»ƒæ¨¡å‹
sh tools/train_Null_v2_math.sh \
    save_LoRA_Null_adapter_llama2_PT_128 \
    save_LoRA_Null_adapter_llama2_PT_128_math_Null_v2_trained

# Step 3: éªŒè¯è®­ç»ƒåçš„é›¶ç©ºé—´å±æ€§
python verify_trained_null_space.py \
    --trained_model_path save_LoRA_Null_adapter_llama2_PT_128_math_Null_v2_trained/ft \
    --calib_loader_size 256 \
    --save_stats trained_verification.json

# Step 4: å¯¹æ¯”åˆå§‹åŒ–å’Œè®­ç»ƒåçš„ç»Ÿè®¡
python compare_stats.py \  # éœ€è¦è‡ªå·±ç¼–å†™å¯¹æ¯”è„šæœ¬
    --init_stats init_verification.json \
    --trained_stats trained_verification.json
```

## ç†è®ºèƒŒæ™¯

### è®­ç»ƒä¸­çš„é›¶ç©ºé—´åŠ¨æ€

**åˆå§‹åŒ–æ—¶**:
```
y = ABX + W_residual @ X
  = 0 @ (BX) + W @ X     # A=0
  = W @ X                # ä¿æŒé¢„è®­ç»ƒè¾“å‡º
```

**è®­ç»ƒå**:
```
y = A_trained @ (BX) + W @ X
```

**å…³é”®é—®é¢˜**: BX æ˜¯å¦ä»ç„¶å¾ˆå°ï¼Ÿ

å¦‚æœ `||BX|| << ||X||` ä»ç„¶æˆç«‹ï¼Œé‚£ä¹ˆï¼š
- å³ä½¿ `A_trained` å¾ˆå¤§ï¼Œ`ABX` ä»ç„¶ç›¸å¯¹è¾ƒå°
- é€‚é…å™¨çš„æ›´æ–°ä¸»è¦åœ¨"ä¸é‡è¦çš„æ–¹å‘"ä¸Š
- é¢„è®­ç»ƒçŸ¥è¯†å¾—åˆ°ä¿æŠ¤

### æ•°å­¦éªŒè¯

è®¾ B çš„åˆ—ç©ºé—´ç”±åæ–¹å·®çŸ©é˜µçš„æœ€å°ç‰¹å¾å‘é‡å¼ æˆï¼Œç‰¹å¾å€¼ä¸º Î»â‚, Î»â‚‚, ..., Î»áµ£ã€‚

é‚£ä¹ˆï¼š
```
E[||BX||Â²] â‰ˆ Î£áµ¢ Î»áµ¢
E[||X||Â²] = Î£â±¼ Ïƒâ±¼  (æ‰€æœ‰ç‰¹å¾å€¼)
```

æ¯”å€¼ï¼š
```
||BX|| / ||X|| â‰ˆ sqrt(Î£áµ¢ Î»áµ¢ / Î£â±¼ Ïƒâ±¼)
```

å¦‚æœé€‰æ‹©æœ€å°çš„ r ä¸ªç‰¹å¾å€¼ï¼Œè¿™ä¸ªæ¯”å€¼åº”è¯¥å¾ˆå°ã€‚

è®­ç»ƒåï¼Œå¦‚æœ B ä¿æŒä¸å˜ï¼Œè¿™ä¸ªæ¯”å€¼ä¸åº”è¯¥æ˜¾è‘—å˜åŒ–ã€‚

## æ€»ç»“

ä½¿ç”¨è¿™ä¸ªè„šæœ¬ï¼Œä½ å¯ä»¥ï¼š

1. âœ… **éªŒè¯é›¶ç©ºé—´ä¿æŒæ€§**: ç¡®è®¤è®­ç»ƒæ²¡æœ‰ç ´åé›¶ç©ºé—´ç»“æ„
2. âœ… **è¯„ä¼°é€‚é…å™¨æœ‰æ•ˆæ€§**: ç¡®è®¤é€‚é…å™¨å­¦åˆ°äº†æœ‰æ„ä¹‰çš„æ›´æ–°
3. âœ… **é‡åŒ–é€‚é…å™¨è´¡çŒ®**: ç†è§£é€‚é…å™¨å¯¹æœ€ç»ˆè¾“å‡ºçš„å½±å“ç¨‹åº¦
4. âœ… **è¯Šæ–­è®­ç»ƒé—®é¢˜**: å‘ç°å‚æ•°å†»ç»“ã€å­¦ä¹ ç‡ç­‰é—®é¢˜

è¿™äº›æŒ‡æ ‡å¸®åŠ©ä½ ç†è§£ LoRA-Null-v2 åœ¨å®é™…è®­ç»ƒä¸­çš„è¡Œä¸ºï¼ŒéªŒè¯å…¶"åœ¨é›¶ç©ºé—´ä¸­å¾®è°ƒ"çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¦å¾—åˆ°å®ç°ã€‚
